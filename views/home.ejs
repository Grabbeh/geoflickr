<!doctype html>
<head>
   <%-include head.ejs %>
   <script src="https://maps-api-ssl.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
   <script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
   <script src="/javascripts/masonry.js" type="text/javascript"></script>

</head>
<body>
   <div id="maincontainer" />
   <%-include header.ejs %>
   <div id="body">
      <div id="container">
         <% include geobuttons.ejs %>
        <div class="row">
          <div class="twelvecol">
            <div class="hover" id="advancedsearch">Show advanced options</div>
            <div id="advancedsearchoptions" style="display: none">

                <form>
                  
                    <div><p><b>Filter by licence</b></p></div>
                   <div id="licenseform"> 
                    <input type="checkbox" name="license" value="0">All rights reserved<br>
                    <input type="checkbox" name="license" value="1">Attribution-Non-Commercial-Share Alike License<br>
                    <input type="checkbox" name="license" value="2">Attribution-Non-Commercial License<br>

                    <input type="checkbox" name="license" value="3">Attribution-Non-Commercial-NoDerivs License<br>
                    <input type="checkbox" name="license" value="4">Attribution License<br>

                    <input type="checkbox" name="license" value="5">Attribution-Share Alike License<br>
                    <input type="checkbox" name="license" value="6">Attribution-No Derivs License<br>
                    <input type="checkbox" name="license" value="7">No known copyright restrictions<br>
                    <input type="checkbox" name="license" value="8">United States Government Work
                  </div>
                </form>
                <form>
                    <div><p><b>Filter by tags</b> (space separated)</p></div>
                    <div>
                    <input class="newinput" type="text" id="tags"> 
                    <input type="submit" class="newbutton hover" value="search" id="searchsubmit">
                  </div>
                </form>
            </div>
          </div>
        </div>
         <div class="row">
            <div class="sixcol">
               <div id="map">
                  <div id="mymap"></div>
               </div>
               <p class="hover" id="locationtoggle">Recent locations - hide</p>
               <ul id="locations">
               </ul>
            </div>
            <div class="sixcol last">
               <div><span id="photonumber"></span><span class="hover" id="previousbutton"></span><span class="hover" id="nextbutton"></span></div>
               <span class="bigimage"></span>
               
               <div id="photos" class="photolist"></div>
             
            </div>
         </div>
         <div class="clearfooter"></div>
      </div>
      <%- include footer.ejs %>
   </div>
</body>
</html>
<script>
   var map;
   var marker;
   var markersarray = [];

   $(document).ready(function() {
  
    create_map();
   
      $('#searchsubmit').click(function(e){
            e.preventDefault();
              if ($('#userlocation').val().length === 0){

                if (!$(this).parent().hasClass("active")){
                             
                             alert("Please provide a location");
                           }
          }
          else {
            geocodeAddress()
          }  
      })

       $("#geolocate").click(function(){ 
       navigator.geolocation.getCurrentPosition(geolocate, function(){});
       });
   
       $('#userlocation').keypress(function (e) {
             if (e.which == 13) {
               geocodeAddress();   
             }
           });
   
       $('#userlocationsubmit').click(function(){
       geocodeAddress();
       });

        $('.photolist').delegate('a', 'click', function(event){
           $('#photonumber').children().eq(1).remove().end();
           $('#previousbutton').text(" Previous / ");
            $('#nextbutton').text("Next");
           var bigImg = $("<img/>").attr("src", $(this).attr('href'));
           $('.bigimage').html(bigImg);
           event.preventDefault();
            if (!$(this).hasClass("active")) {
            // Remove the class from anything that is active
            $("a.active").removeClass("active");
            // And make this active
            $(this).addClass("active");
            }
        })


        $('#nextbutton').click(function(e){
          var nextImg = $('<img/>').attr("src", $('a.active').parent().next().find('a').attr('href'))
          $('.bigimage').html(nextImg);
          $('a.active').parent().next().find('a').addClass("active");
          $('a.active').parent().prev().find('a').removeClass("active");
          event.preventDefault()

        })

        $('#previousbutton').click(function(e){
         var prevImg = $('<img/>').attr("src", $('a.active').parent().prev().find('a').attr('href'))
          $('.bigimage').html(prevImg);
          $('a.active').parent().prev().find('a').addClass("active");
          $('a.active').parent().next().find('a').removeClass("active");
          event.preventDefault()
        })

        $('#advancedsearch').click(function(){
          $('#advancedsearchoptions').toggle('slow', function(){

              if ($('#advancedsearchoptions').is(':visible')){
                  $('#advancedsearch').text('Hide advanced options');
                }
            else {
              $('#advancedsearch').text('Show advanced options');
            }
          });
        })

        $('#locationtoggle').click(function(){
          $('#locations').toggle('slow', function(){

            if($('#locations').is(':visible')){
              $('#locationtoggle').text('Recent locations - hide')
            }
            else {
              $('#locationtoggle').text('Recent locations - show')
            }
          })
        })

   });
   
       function create_map() {
           
           var mapOptions = {
               center: new google.maps.LatLng(51.50678771873268, -0.1271748905517142),
               zoom: 2,
               mapTypeId: google.maps.MapTypeId.ROADMAP,
               panControl: false,
               zoomControl: false,
               scaleControl: false,
               zoomControl: true,
               draggableCursor: "default",
               zoomControlOptions: {
                   style: google.maps.ZoomControlStyle.SMALL
               },
               streetViewControl: false
           };
       
           map = new google.maps.Map(document.getElementById("mymap"), mapOptions);
   
   google.maps.event.addListener(map, 'click', function(event) {
    
     var latLon = event.latLng;
      reverseGeocode(latLon);
     var lat = latLon.lat();
     var lon = latLon.lng();
     map.setCenter(latLon);
        clearMarker();
        ajaxLatLonPost(lat, lon);
        placeMarker(event.latLng);
  
   });
  }
   
  function addMarkerDragListener(marker){
    google.maps.event.addListener(marker, 'dragend', function(event){
    var latLon = marker.getPosition();
      reverseGeocode(latLon);
      var lat = latLon.lat();
      var lon = latLon.lng();
      ajaxLatLonPost(lat, lon);
      })
  }

  function addSubmitListener(marker){
    $('#searchsubmit').parent().addClass("active");
      $('#searchsubmit').click(function(e){
    
      var latLon = marker.getPosition();
      reverseGeocode(latLon);
      var lat = latLon.lat();
      var lon = latLon.lng();
      ajaxLatLonPost(lat, lon);
      })
  }


   function ajaxLatLonPost(lat, lon) {

      collectLicenseData();
      var tag = $('#tags').val().split(" ")

               var obj = {
               lat: lat,
               lon: lon,
               tag: tag,
               licenses: licenses
           }; 


           $.ajax({
               url: "/test",
               type: "POST",
               contentType: "application/json",
               processData: false,
               data: JSON.stringify(obj),
               success: function(data) {
                  clearReferences();
                   processFlickrData(data);
               }
           });
       };
   
   function placeMarker(location) {
     marker = new google.maps.Marker({
         position: location,
         map: map,
         flat: true,
         draggable: true
     });
      if (map.getZoom() < 13) {
      map.setZoom(13)
     }
     markersarray.push(marker);
     addSubmitListener(marker);
     addMarkerDragListener(marker);
   };
   
   function clearMarker() {
     if (markersarray) {
       for (i in markersarray) {
         markersarray[i].setMap(null);
       }
       markersarray.length = 0;
     }
   };

   function clearReferences(){
      $('#previousbutton').text("");
      $('#nextbutton').text("");
       $('#photonumber').children().remove().end();
       $('#photos').children().remove().end();
       $('.bigimage').children().remove().end();
   }

   function geolocate(pos){
   
       var lat = pos.coords.latitude;
       var lon = pos.coords.longitude;
       center = new google.maps.LatLng(lat, lon);
       reverseGeocode(center);
       map.setCenter(center);
       
       clearMarker();
       ajaxLatLonPost(lat, lon);
       placeMarker(center);
           
   };
   
   // geocode function if user inputs location
   
   function geocodeAddress(){
        var address = $("#userlocation").val();
        geocoder = new google.maps.Geocoder();
        geocoder.geocode({'address': address}, function(results, status){
           if (status == google.maps.GeocoderStatus.OK) {
              
               $('#locations').append("<li>" + results[0].formatted_address + "</li>");
               var userloc = results[0].geometry.location;
               map.setCenter(userloc);
               var lat = userloc.lat();
               var lon = userloc.lng();
               clearMarker();
               clearReferences();
               ajaxLatLonPost(lat, lon);
               placeMarker(userloc);
               $('#userlocation').val("");
              
           }
           else{
               alert("Sorry, we didn't recognise this location");
           }
        });
    };
   
    function reverseGeocode(latLon){
     geocoder = new google.maps.Geocoder();
       geocoder.geocode({location: latLon}, function(results, status){
         
           $('#locations').append("<li>" + results[0].formatted_address + "</li>");
         
         })
    }
   
   function processFlickrData(data){
   
   var photos = data.photo;
   
   if (photos.length > 0){

          if (photos.length === 1){
              $('#photonumber').append("<span><b>" + photos.length + " lonely photo - click to enlarge" + "</b></span>");
          } 
          else {
            $('#photonumber').append("<span><b>" + photos.length +  " photos" + "</b></span><span>" + " - click to enlarge" + "</span>");
          
          }

   
   for (var i = 0; i < photos.length; i++) {
       var farmId = photos[i].farm;
       var serverId = photos[i].server;
       var photoId = photos[i].id;
       var photoSecret = photos[i].secret;
   
       var thumbnail = "http://farm" +  farmId + ".staticflickr.com/" + serverId + "/" + photoId + "_" + photoSecret + "_t.jpg"
       var mainurl = "http://farm" +  farmId + ".staticflickr.com/" + serverId + "/" + photoId + "_" + photoSecret + ".jpg"
   
   
       $('#photos').append("<span>" + "<a href=" + mainurl + ">" + "<img src=" + thumbnail + "></a></span>").addClass('photobox');

       };
   }
   else {
       $('#photos').append("<span>" + "Sorry, no photos for here" + "</span>");
   }
   
   }

   function collectLicenseData(){
    licenses = [];
        var buttonsChecked = $('#licenseform :checked');

        if (buttonsChecked.length) {
        $('#licenseform :checked').each(function(){
          licenses.push($(this).val())
        })
      }
  else{
        licenses = [0, 1, 2, 3, 4, 5, 6, 7, 8]
       }

   }

</script>